{% extends "base.html" %} {% block title %}Logs em Tempo Real - Analisador de
Avarias{% endblock %} {% block content %}
<div class="row">
  <!-- Cabeçalho -->
  <div class="col-12 mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h2 mb-1">
          <i class="bi bi-terminal text-primary me-2"></i>Logs em Tempo Real
        </h1>
        <p class="text-muted">
          Acompanhe o processamento das imagens em tempo real
        </p>
      </div>
      <div>
        <button id="toggleAutoScroll" class="btn btn-outline-secondary me-2">
          <i class="bi bi-arrow-down-circle"></i> Auto-scroll:
          <span id="autoScrollStatus">ON</span>
        </button>
        <button id="clearLogs" class="btn btn-outline-warning me-2">
          <i class="bi bi-trash"></i> Limpar
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <!-- Status do Processamento -->
  <div class="col-12 mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <div id="statusIcon" class="me-3">
                <i class="bi bi-clock text-warning fs-3"></i>
              </div>
              <div>
                <h5 id="statusText" class="mb-1">Aguardando...</h5>
                <small id="statusTime" class="text-muted"
                  >Última atualização: --:--:--</small
                >
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="progress mb-2" style="height: 20px">
              <div
                id="progressBar"
                class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                <span id="progressText">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Console de Logs -->
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-dark text-white">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-terminal me-2"></i>
            Console de Logs
          </div>
          <div>
            <small id="logCount">0 linhas</small>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <div
          id="logConsole"
          class="bg-dark text-light p-3 overflow-auto"
          style="
            height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
          "
        >
          <div class="text-muted">
            <i class="bi bi-info-circle me-2"></i>Aguardando logs...
          </div>
        </div>
      </div>
      <div class="card-footer bg-light">
        <div class="row">
          <div class="col-md-6">
            <small class="text-muted">
              <i class="bi bi-circle-fill text-success me-1"></i>Processado
              <i class="bi bi-circle-fill text-info me-1 ms-3"></i>Progresso
              <i class="bi bi-circle-fill text-warning me-1 ms-3"></i>Consumo
              <i class="bi bi-circle-fill text-danger me-1 ms-3"></i>Erro
            </small>
          </div>
          <div class="col-md-6 text-end">
            <small class="text-muted">
              Atualização automática a cada 2 segundos
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .log-entry {
    margin: 2px 0;
    padding: 2px 8px;
    border-radius: 3px;
    border-left: 3px solid transparent;
  }

  .log-processado {
    border-left-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
  }

  .log-progresso {
    border-left-color: #17a2b8;
    background-color: rgba(23, 162, 184, 0.1);
  }

  .log-consumo {
    border-left-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
  }

  .log-erro {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
  }

  .log-timestamp {
    color: #6c757d;
    font-size: 11px;
  }

  #logConsole::-webkit-scrollbar {
    width: 8px;
  }

  #logConsole::-webkit-scrollbar-track {
    background: #2d3748;
  }

  #logConsole::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 4px;
  }

  #logConsole::-webkit-scrollbar-thumb:hover {
    background: #718096;
  }
</style>

<script>
  let autoScroll = true;
  let logCount = 0;
  let updateInterval;

  document.addEventListener("DOMContentLoaded", function () {
    // Elementos
    const logConsole = document.getElementById("logConsole");
    const toggleAutoScrollBtn = document.getElementById("toggleAutoScroll");
    const autoScrollStatus = document.getElementById("autoScrollStatus");
    const clearLogsBtn = document.getElementById("clearLogs");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const statusIcon = document.getElementById("statusIcon");
    const statusText = document.getElementById("statusText");
    const statusTime = document.getElementById("statusTime");
    const logCountEl = document.getElementById("logCount");

    // Configurar botões
    toggleAutoScrollBtn.addEventListener("click", function () {
      autoScroll = !autoScroll;
      autoScrollStatus.textContent = autoScroll ? "ON" : "OFF";
      this.className = autoScroll
        ? "btn btn-outline-secondary me-2"
        : "btn btn-outline-warning me-2";
    });

    clearLogsBtn.addEventListener("click", function () {
      logConsole.innerHTML =
        '<div class="text-muted"><i class="bi bi-info-circle me-2"></i>Logs limpos...</div>';
      logCount = 0;
      updateLogCount();
    });

    // Função para atualizar logs
    function updateLogs() {
      fetch("/api/logs")
        .then((response) => response.json())
        .then((data) => {
          updateStatus(data.progresso, data.processamento_ativo);
          updateLogDisplay(data.logs);
        })
        .catch((error) => {
          console.error("Erro ao buscar logs:", error);
          addLogEntry(
            "erro",
            new Date().toLocaleTimeString(),
            "Erro de conexão com servidor"
          );
        });
    }

    // Atualizar status do processamento
    function updateStatus(progresso, ativo) {
      const progress = progresso.progresso || 0;
      const status = progresso.status || "Aguardando";

      // Atualizar barra de progresso
      progressBar.style.width = progress + "%";
      progressBar.setAttribute("aria-valuenow", progress);
      progressText.textContent = progress + "%";

      // Atualizar cor da barra
      progressBar.className = "progress-bar progress-bar-striped";
      if (ativo) {
        progressBar.classList.add("progress-bar-animated");
        if (progress >= 100) {
          progressBar.classList.add("bg-success");
        } else {
          progressBar.classList.add("bg-primary");
        }
      } else {
        if (progress >= 100) {
          progressBar.classList.add("bg-success");
        } else if (progress > 0) {
          progressBar.classList.add("bg-warning");
        } else {
          progressBar.classList.add("bg-secondary");
        }
      }

      // Atualizar ícone de status
      if (ativo) {
        statusIcon.innerHTML =
          '<i class="bi bi-gear-fill text-primary fs-3 spin"></i>';
      } else if (progress >= 100) {
        statusIcon.innerHTML =
          '<i class="bi bi-check-circle-fill text-success fs-3"></i>';
      } else {
        statusIcon.innerHTML = '<i class="bi bi-clock text-warning fs-3"></i>';
      }

      // Atualizar texto de status
      statusText.textContent = status;
      statusTime.textContent =
        "Última atualização: " + new Date().toLocaleTimeString();
    }

    // Atualizar display de logs
    function updateLogDisplay(logs) {
      if (!logs || logs.length === 0) return;

      // Limpar console se necessário
      if (logCount === 0) {
        logConsole.innerHTML = "";
      }

      // Adicionar novos logs
      logs.forEach((log) => {
        addLogEntry(log.tipo, log.timestamp, log.mensagem);
      });

      updateLogCount();
    }

    // Adicionar entrada de log
    function addLogEntry(tipo, timestamp, mensagem) {
      const logEntry = document.createElement("div");
      logEntry.className = `log-entry log-${tipo}`;

      logEntry.innerHTML = `
      <span class="log-timestamp">[${timestamp}]</span>
      <span class="ms-2">${mensagem}</span>
    `;

      logConsole.appendChild(logEntry);
      logCount++;

      // Auto-scroll se ativado
      if (autoScroll) {
        logConsole.scrollTop = logConsole.scrollHeight;
      }
    }

    // Atualizar contador de logs
    function updateLogCount() {
      logCountEl.textContent = logCount + " linhas";
    }

    // Iniciar atualizações automáticas
    function startUpdates() {
      updateLogs(); // Primeira busca
      updateInterval = setInterval(updateLogs, 2000); // A cada 2 segundos
    }

    // Parar atualizações
    function stopUpdates() {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
    }

    // Iniciar
    startUpdates();

    // Limpar intervalo quando sair da página
    window.addEventListener("beforeunload", stopUpdates);
  });

  // CSS para animação de rotação
  const style = document.createElement("style");
  style.textContent = `
  .spin {
    animation: spin 2s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
  document.head.appendChild(style);
</script>
{% endblock %}
